#!/bin/bash

# This wrapper script is used to run non-plugin server processes using
# the plugin server mechanism.  Such processes need to terminate
# themselves when their parent process dies for any reason.  This
# script implements that behavior and forwards all signals that it
# receives to the wrapped process.  The process itself must run in the
# foreground.

# usage: pluginserver-wrapper <command> [ <arg> ... ]

parent_pid=$(ps -o ppid= -p $$)

"$@" &
server_pid=$!

for signal in $(kill -l)
do
    trap "kill -$signal $server_pid" $signal
done

while true
do
	if ! kill -0 $server_pid >& /dev/null
	then
		wait >& /dev/null
		exit 1
	fi
	if ! kill -0 $parent_pid >& /dev/null
	then
		kill -TERM $server_pid
		wait >& /dev/null
		exit 1
	fi
        sleep 1
done
